name: Test

on:
  workflow_call:
    inputs:
      build-image:
        required: false
        type: boolean
        default: true
      run-fuzz-tests:
        required: false
        type: boolean
        default: true
      fuzz-with-race:
        required: false
        type: boolean
        default: false

permissions:
  contents: read

jobs:
  race-test:
    name: Test with race detector
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Install Go
        uses: WillAbides/setup-go-faster@v1.14.0
        with:
          go-version-file: go.mod

      - name: Restore Go cache
        uses: capnspacehook/cache-go/restore@v2.0.1

      - name: Ensure main package builds
        run: |
          go build

      - name: Run tests
        run: |
          go test -race -timeout 5m -v ./...

      - name: Save Go cache
        if: always()
        uses: capnspacehook/cache-go/save@v2.0.1

  fuzz:
    name: Fuzz code
    runs-on: ubuntu-latest
    needs: race-test
    if: inputs.run-fuzz-tests == 'true'
    timeout-minutes: 60
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Install Go
        uses: WillAbides/setup-go-faster@v1.14.0
        with:
          go-version-file: go.mod

      - name: Restore Go cache
        uses: capnspacehook/cache-go/restore@v2.0.1
        with:
          cache-fuzz-corpus: true

      - name: Fuzz code for 10 minutes
        run: |
          RACE_FLAG=""
          if [[ "${{ inputs.fuzz-with-race }}" = "true" ]]; then
            RACE_FLAG="-race"
          fi
          
          find . -type f -name '*_test.go' -exec grep -l '^func Fuzz' {} \; | while read -r FILE; do
              grep '^func Fuzz' "$FILE" | sed 's/func \(Fuzz[^(]*\).*/\1/' | while read -r FUZZ_NAME; do
                  echo "Running fuzz test: $FUZZ_NAME in $FILE"
                  (cd "$test_dir" && go test ${RACE_FLAG} -run DONOT -fuzz="^${FUZZ_NAME}$" -fuzztime=10m) || exit 1
              done
          done

      - name: Save Go cache
        if: always()
        uses: capnspacehook/cache-go/save@v2.0.1
        with:
          cache-fuzz-corpus: true

  build-image:
    name: Build Docker image
    runs-on: ubuntu-latest
    # only run this check on pull requests, pushes to master will trigger
    # an image release
    if: contains(github.ref, 'pull') && inputs.build-image
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Install Docker buildx
        uses: docker/setup-buildx-action@v3

      - name: Ensure Docker image builds
        uses: docker/build-push-action@v6
        with:
          load: true
          push: false
          tags: ghcr.io/${{ github.repository }}:build-test
